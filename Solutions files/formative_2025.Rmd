---
title: "Formative solution_LH36264"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. **Note** I have left the commands below so you have some information on using R notebooks.


Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
plot(cars)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

## Some tips on use

You can make words emboldened by using the **add in your text** 

You use *add in your text* for italics

***add in your text *** creates bold and italic text.

The hash character generates headings of different sizes

# Heading 1

## Heading 2

### Heading 3 etc

There us much more that can be done in terms of text formatting.Click on the 'preview' option and then click on the R markdown link (see above)!

## Formative assessment outline

Use this a template if you want to use a notebook for your submissions.Your report needs the following sections.
1. An introduction that outlines the research and the research gap. This will conclude with some research questions. These guide the analyses.

2. A section on data exploration. This needs some supporting reading. Check Zuur et al. on data exploration steps. And read other texts. The section will have code and results outlines with some interpretation. **Do not be tempted to throw the kitchen sink at it**.

3. A section on analytical methods you'll use and why. Add in reading.

4. A section on the analyses. This will include your tables and figures including descriptions of the results from the tables and figures. 

5. A brief discussion contextualising the findings in relation to the reading.

## A worked example

### Introduction

The usual preliminaries....perhaps adding why these packages. 
```{r}
# Load libraries we need.
library(tidyverse)
library(car)
library(ggsignif) # new library you'll need to install it.
library(dplyr) 
library(tidyr)

```

The next step is to load the data.
```{r}
# Load data
pred <- read.csv("~/Documents/GitHub/Teaching/LM_25556Environmental_Analysis/Data/fish_pred.csv")

```

### Data exploration
First up. Look at the data and explain its structure.
```{r}
glimpse(pred)
```
This needs describing. The file has 20 rows and 3 columns. Two columns are character data but R will interpret them as factors. Column 3 is density of chironomid larvae in the experiments. It is a dbl or continuous. With two factor and one continuous data field we should be considering ANOVA (two-way). Safer to change the characters to factors.

```{r}
# change character fields to factors 
pred$Bullhead <- as.factor(pred$Bullhead)
pred$Loach <- as.factor(pred$Loach)
glimpse(pred) # check it worked
```
It has worked. Now we need to check for balance which is necessary for a two-way ANOVA, otherwise we'd need to use a different error-structure. Murray Logan's book describes this in painful detail, if you are keen to learn more. We have an electronic copy of this too.
```{r}
table(pred$Bullhead, pred$Loach)
# Fine so we can go with 2 way ANOVA (as we have one response and two FACTORS)
# Note - the fish are either present or absent...
```
Now draw some pictures. 

```{r}
op <- par(mfrow = c(1, 2)) # 1 row , 2 columns for the images
boxplot(Density ~ Bullhead, col = "lightblue", data = pred, xlab = "Bullhead")
boxplot(Density ~ Loach, col = "lightblue", data = pred, xlab = "Loach")
par(op)
```
Explain the key patterns you see......Bullhead have no appreciable impact on chironomid densities aside of reducing their variability somewhat. Presumably because as they are algal grazers it stabilises algal biomass so lessening chironomid variability as many midge species are grazers too. But there is a clear impact of loach on midge densities via predation.

I provide another plot for the ggplot users. But it requires the data to be in tidy or long format. This is needed later anyway to generate the final plot. Please note it is not necessary to generate two boxplots. Either are acceptable, base R or ggplot. You could explain why this was needed and what package you used to do it etc....with supporting reading.
```{r}
# Or in ggplot - need to transform the data to a long format to do this easily
pred_long <- pred %>% gather(species,treatment, 1:2)
glimpse(pred_long) # looks fine we'll flip new variables to factors as we're going to create error bars plots 
pred_long <- pred_long %>% mutate(species = factor(species),treatment = factor(treatment)) # use glimpse(pred_long) to check it worked
```
Explain the new dataframe variables.

And now the plot.
```{r}
ggplot(pred_long, aes(y=Density, x=species, fill=treatment)) + geom_boxplot() +
  labs(x = "Fish species", y = "Prey Density", fill = "Treatment") 
# Variances look okay and the pattern indicates that Loach reduce midge density but Bullheads don't.
```
You can check the assumptions *a priori* if you wish but this is not absolutely necessary. 

Check for normality first using qq-plots - explain the plot if you use it.
```{r}
qqnorm(pred$Density); qqline(pred$Density)
```
Data points conform to the line so normality is assumed. You can confirm this with a Shapiro-Wilkes test if you wish.
```{r}
shapiro.test(pred$Density)
# Data are normally distributed....
```
Yes P>0.05 so it is fine. The truth is normality could be assumed from the boxplots and you ought to describe that when outlining what they show. The next step would be to examining homogeneity of variance with some plots from the car package or a Levene's test. Same applies here. It is not really necessary as you can infer this from the boxplots. 
```{r}
# Homogeneity of variance
leveneTest(pred$Density ~ pred$Bullhead * pred$Loach) # No issues visible
```
It's fine, p>0.05.

As you have two factors this is shaping up to be a ANOVA test then have a look at possible interactions.
```{r}
#plot interaction
interaction.plot(pred$Bullhead, pred$Loach, pred$Density, col=c(2,3), xlab = "Predators", ylab = "Midge Density", trace.label = "")
```
Indicates no interaction. We are now ready to run the analyses.

## Analytical methods
Review what you are going to do and why using the exploration work above and some reading to justify your selections. You have one continuous response, and two factors derived from a fish predation experiment; you'll be using a two-way ANOVA.

## Results/Analyses

```{r}
# Run ANOVA
pred_aov <- aov(Density ~ Loach * Bullhead, data = pred)

# Look at the output
summary(pred_aov)
```
Results indicate that Loach presence reduces midge density (p=0.00189) but bullheads don't (p>0.05). There is no interaction between the two explanatories (or the fish), so the addition of bullheads to the tanks did not result in greater impact on midge density.

## Model Validation
This is key step explain why and refer to some reading.

```{r}
op <- par(mfrow = c(2, 2)) # set graphics device to plot four graphs in a 2 x 2 matrix
plot(pred_aov)
par(op)
```
Explain what each box is showing. Explanations of these are in Zuur's Ecological Analysis book and Beckerman et al. We have electronic copies of both available in Library Services. Remember you can use the autoplot() function too, but you'll need to load the ggfortify package.

In short there are no big issues. There are no worrying patterns in residuals data point 13 stands out a little, so we'll look at it via leverage/Cook's Distance outlier plots.
```{r}
plot(pred_aov, which=6) 
```
We are looking for Cook's distance (D) to be <1. Point 13 is well below this. All is good. Add in reading to support the statement.

Now we are good to visualise the patterns. It is an ANOVA so we need an error bar chart. Plot barchart with error bars to show the pattern for a report - we'll go for a publication level type file and output it to a file at high resolution. We'll use ggplot and the reshaped dataframe pred_long. We need toalculate the mean, sd, se and IC.
```{r}
pred_sum <- pred_long %>%
  group_by(species,treatment) %>%
  summarise( 
    n=n(),
    mean=mean(Density),
    sd=sd(Density)) %>%
  mutate( se=sd/sqrt(n))  %>% # computes the standard error
  mutate( ic=se * qt((1-0.05)/2 + .5, n-1)) # computes 95% CI
```
Now we can create the plot using 2 standard error [at 95% or p=0.05 level]. **Note:** the errors don't overlap for Bullhead absence/presence but they do for Loach.
```{r}
ggplot(pred_sum, aes(x=species, y=mean, fill=treatment)) +
  geom_bar(position=position_dodge(), stat="identity", colour='black') +
  geom_errorbar(aes(ymin=mean-2*se, ymax=mean+2*se), width=.2,position=position_dodge(.9)) + 
  labs(x = "Fish species", y = "Prey Density", fill = "Treatment") + theme_bw()

```
NOTE you need the position=position.dodge function to locate the error bars over the bars. The width function scales the width of the error bar = trying playing with it to see. Worth explaining this.

## Creating and saving a publication ready plot
We will do this with ggplot2 and use lots of different functions. Check the code carefully. While I'd like to see well designed plots in your work a tidy ggplot will do. 

```{r}
ggplot(pred_sum, aes(x=species, y=mean, fill=treatment)) +
  geom_bar(position=position_dodge(), stat="identity", colour='black') +
  geom_errorbar(aes(ymin=mean-ic, ymax=mean+ic),width=.2,position=position_dodge(.9)) + 
  theme_bw() + # remove default grey background
  scale_fill_manual(values = c("grey90","grey50")) + # override colours for treatment making them grey and white bars
  theme(axis.title = element_text(size = 12),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x  = element_text(size=10, colour="black"),
        axis.text.y  = element_text(size=10, colour="black"),
        plot.caption=element_text(hjust = 0)) +
  labs(x = "Species", y = expression(Prey~Density~(m^2)), fill = "Treatment", 
       caption = "Figure 1. Species impacts on prey density in experiment enclosures.\nn = 10 per treatment group (total = 40) ** = p<0.01.\nError bars are 95 and 5% CIs.") +
  # \n = new line in caption
  # to add significant level use the annotate function. Check the aov call for sig levels
  annotate("text", x=2, y=4.2, label= "**") +
  annotate("text", x=1, y=4.2, label= "NS") + theme(
  plot.caption = element_text(size = 12)
  )

```
In your project you'll need a small discussion to draw it all together.

## Discussion
Summarise key findings first then contextualise them against the readings.

## References
Don't forget to add the readings. You can automate this in a R notebook in a variety of ways. I use Zotero to manage my paper PDFs and this is easily integrated, especially using a Quarto document. But with a few references is more sensible to just type them out, especially as you need to create a **.bib** file to support the citations. 

